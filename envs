#!/usr/bin/env bash

# envs - .env files manager
# https://github.com/longdog/envs

set -euo pipefail

echo "envs - .env files manager"


sanitize_url() {
    local url="$1"
    # Replace protocol prefixes
    url="${url#https://}"
    url="${url#http://}"
    url="${url#ssh://}"
    url="${url#git://}"
    # Replace all remaining special chars
    echo "$url" | sed -E 's/[^a-zA-Z0-9._-]+/-/g'
}

if ! git=$(git remote get-url origin 2>/dev/null); then
    echo "Error: Not a git repository or no remote 'origin'" >&2
    exit 1
fi
origin=$(sanitize_url "$git")

: "${HOME:?Error: HOME directory not set}"
config="${HOME}/.config/envs"

project=$(git rev-parse --show-toplevel)
current=$(realpath --relative-to="$project" .)
env="$config/$origin/$current/.env"
echo "Managing .env for project: ${origin}/${current}"
mkdir -p "$(dirname "$env")"

# If central .env doesn't exist but local does, preserve it
    if [[ ! -f "$env" && -f ".env" ]]; then
        echo "Preserving existing .env file"
        mv ".env" "$env"
    fi

touch "$env"
ln -sf "$env" .env

echo "Symlink created: .env -> ${env}"
